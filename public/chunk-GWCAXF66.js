import{d as l}from"./chunk-FTFMUACC.js";import{K as u,P as m}from"./chunk-U4S3JRSN.js";var O=class c{firestoreService=m(l);ORDERS_COLLECTION="orders";MESSAGES_COLLECTION="messages";generateOrderNumber(){let e=new Date().getFullYear(),r=Date.now().toString().slice(-6);return`ORD-${e}-${r}`}async createOrder(e,r){try{let t=this.firestoreService.getTimestamp(),i=this.generateOrderNumber(),o=`order_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,n={status:"pending",changedAt:t,changedBy:r,changedByEmail:e.customerEmail,changedByRole:"customer",notes:"Order created"},s=`${e.reportType.name} - ${e.projectAddress}`,a={orderNumber:i,customerId:e.customerId,customerEmail:e.customerEmail,customerName:e.customerName,projectAddress:e.projectAddress,latitude:e.latitude||null,longitude:e.longitude||null,location:e.location||null,reportType:e.reportType,addons:e.addons,structureCategory:e.structureCategory,structureCategoryName:e.structureCategoryName,structureCategorySqRange:e.structureCategorySqRange,primaryPitch:e.primaryPitch||"",secondaryPitch:e.secondaryPitch||"",specialInstructions:e.specialInstructions||"",basePrice:e.basePrice,addonsTotal:e.addonsTotal,totalPrice:e.totalPrice,status:"pending",statusTimeline:[n],siteImages:[],designFiles:[],createdAt:t,updatedAt:t,priority:e.priority,projectName:s,projectDescription:e.specialInstructions||""};return await this.firestoreService.setDocument(this.ORDERS_COLLECTION,o,a),o}catch(t){throw console.error("Error creating order:",t),t}}async getOrder(e){try{return await this.firestoreService.getDocument(this.ORDERS_COLLECTION,e)}catch(r){throw console.error("Error getting order:",r),r}}async updateOrderStatus(e,r,t,i,o,n){try{let s=this.firestoreService.getTimestamp(),a=await this.getOrder(e);if(!a)throw new Error("Order not found");let d={status:r,changedAt:s,changedBy:t,changedByEmail:i,changedByRole:o,notes:n||""},g={status:r,statusTimeline:[...a.statusTimeline,d],updatedAt:s};r==="completed"&&(g.completedAt=s),await this.firestoreService.updateDocument(this.ORDERS_COLLECTION,e,g)}catch(s){throw console.error("Error updating order status:",s),s}}async assignDesigner(e,r,t,i,o){try{let n=this.firestoreService.getTimestamp(),s=await this.getOrder(e);if(!s)throw new Error("Order not found");let a={status:s.status,changedAt:n,changedBy:i,changedByEmail:o,changedByRole:"admin",notes:`Assigned to designer: ${t}`};await this.firestoreService.updateDocument(this.ORDERS_COLLECTION,e,{assignedDesignerId:r,assignedDesignerEmail:t,statusTimeline:[...s.statusTimeline,a],updatedAt:n})}catch(n){throw console.error("Error assigning designer:",n),n}}async getStatusTimeline(e){try{return(await this.getOrder(e))?.statusTimeline||[]}catch(r){throw console.error("Error getting status timeline:",r),r}}async getOrdersByCustomer(e){try{let{where:r,orderBy:t}=this.firestoreService.getQueryHelpers();return await this.firestoreService.getDocuments(this.ORDERS_COLLECTION,[r("customerId","==",e),t("createdAt","desc")])}catch(r){throw console.error("Error getting customer orders:",r),r}}async getOrdersByDesigner(e){try{let{where:r,orderBy:t}=this.firestoreService.getQueryHelpers();return await this.firestoreService.getDocuments(this.ORDERS_COLLECTION,[r("assignedDesignerId","==",e),t("createdAt","desc")])}catch(r){throw console.error("Error getting designer orders:",r),r}}async getAllOrders(){try{let{orderBy:e}=this.firestoreService.getQueryHelpers();return await this.firestoreService.getDocuments(this.ORDERS_COLLECTION,[e("createdAt","desc")])}catch(e){throw console.error("Error getting all orders:",e),e}}allOrdersListener(e=50){let{orderBy:r,limit:t}=this.firestoreService.getQueryHelpers();return this.firestoreService.collectionListener(this.ORDERS_COLLECTION,[r("createdAt","desc"),t(e)])}async getOrdersByStatus(e){try{let{where:r,orderBy:t}=this.firestoreService.getQueryHelpers();return await this.firestoreService.getDocuments(this.ORDERS_COLLECTION,[r("status","==",e),t("createdAt","desc")])}catch(r){throw console.error("Error getting orders by status:",r),r}}orderListener(e){return this.firestoreService.documentListener(this.ORDERS_COLLECTION,e)}customerOrdersListener(e){let{where:r,orderBy:t}=this.firestoreService.getQueryHelpers();return this.firestoreService.collectionListener(this.ORDERS_COLLECTION,[r("customerId","==",e),t("createdAt","desc")])}async addMessage(e,r,t,i,o,n){try{let s=this.firestoreService.getTimestamp(),a=`msg_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,d={orderId:e,senderId:r,senderEmail:t,senderRole:i,message:o,attachments:n||[],createdAt:s,isRead:!1,readBy:[r]};await this.firestoreService.setDocument(`${this.ORDERS_COLLECTION}/${e}/${this.MESSAGES_COLLECTION}`,a,d)}catch(s){throw console.error("Error adding message:",s),s}}async getOrderMessages(e){try{let{orderBy:r}=this.firestoreService.getQueryHelpers();return await this.firestoreService.getDocuments(`${this.ORDERS_COLLECTION}/${e}/${this.MESSAGES_COLLECTION}`,[r("createdAt","asc")])}catch(r){throw console.error("Error getting order messages:",r),r}}orderMessagesListener(e){let{orderBy:r}=this.firestoreService.getQueryHelpers();return this.firestoreService.collectionListener(`${this.ORDERS_COLLECTION}/${e}/${this.MESSAGES_COLLECTION}`,[r("createdAt","asc")])}async addSiteImages(e,r){try{let t=await this.getOrder(e);if(!t)throw new Error("Order not found");let i=[...t.siteImages,...r];await this.firestoreService.updateDocument(this.ORDERS_COLLECTION,e,{siteImages:i})}catch(t){throw console.error("Error adding site images:",t),t}}async addDesignFiles(e,r){try{let t=await this.getOrder(e);if(!t)throw new Error("Order not found");let i=[...t.designFiles,...r];await this.firestoreService.updateDocument(this.ORDERS_COLLECTION,e,{designFiles:i})}catch(t){throw console.error("Error adding design files:",t),t}}static \u0275fac=function(r){return new(r||c)};static \u0275prov=u({token:c,factory:c.\u0275fac,providedIn:"root"})};export{O as a};
